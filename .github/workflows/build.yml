name: Build MTProto Proxy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        docker build -t mtproto-proxy .
      
    - name: Test the image
      run: |
        # Run container in background
        docker run -d --name mtproxy-test -p 8443:443 mtproto-proxy
        sleep 10
        
        # Check if container is running
        if docker ps | grep mtproxy-test; then
          echo "✅ Container is running successfully"
          # Get logs to see the secret
          docker logs mtproxy-test
        else
          echo "❌ Container failed to start"
          docker logs mtproxy-test
          exit 1
        fi
        
        # Cleanup
        docker stop mtproxy-test
        docker rm mtproxy-test

    - name: Generate deployment instructions
      run: |
        echo "## Deployment Instructions" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### To deploy on your server:" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "git clone https://github.com/$GITHUB_REPOSITORY.git" >> $GITHUB_STEP_SUMMARY
        echo "cd $(basename $GITHUB_REPOSITORY)" >> $GITHUB_STEP_SUMMARY
        echo "docker build -t mtproto-proxy ." >> $GITHUB_STEP_SUMMARY
        echo "docker run -d --name mtproxy -p 443:443 mtproto-proxy" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
